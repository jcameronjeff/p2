name: "Publish Tailwind Theme"
on:
  # Trigger the workflow on push or pull request,
  # but only for the main branch
  push:
    branches:
      - next
jobs:
  build:
    # This steps is only performed when the commit message matches that generated by
    # yarn bump:prerelease or yarn:bumprelease.
    # 1. Create a release/* branch
    # 2. Run yarn bump:prerelease for previews or yarn bump:release for a production version.
    #    This will increment version numbers with Lerna's diff algorithm.
    # 3. Push your branch *to the main repository*
    # 4. Submit a PR targeting the next/master branch. (Do not modify the commit message**)
    # 5. Updated packages will immediately be published to Artifactory when merging PR.
    # ---
    # * Do not modify the commit message except to append 'skip-test'. See below.
    runs-on: CAI-Enterprise
    strategy:
      matrix:
        node-version: [16.x]
    steps:
      - uses: actions/checkout@v2
      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v2
        with:
          node-version: ${{ matrix.node-version }}
          token: ${{ secrets.ARTIFACTORY_TOKEN }}
          always-auth: true

      - name: Configure Artifactory Access
        env:
          ARTIFACTORY_USERNAME: ${{ secrets.ARTIFACTORY_EMAIL }}
          ARTIFACTORY_API_KEY: ${{ secrets.ARTIFACTORY_TOKEN }}
          ARTIFACTORY_AUTH_URL: https://artifactory.coxautoinc.com/artifactory/api/npm/auth
        # Create a temporary .npmrc file to use for authentication
        # todo : there must be a better way
        run: |
          echo 'registry=https://artifactory.coxautoinc.com/artifactory/api/npm/man-npm' >> .npmrc
          curl -u${ARTIFACTORY_USERNAME}:${ARTIFACTORY_API_KEY} ${ARTIFACTORY_AUTH_URL} >> .npmrc
          npm config set userconfig .npmrc
          npm config ls -l

      - name : Install pnpm
        run: npm i -g pnpm

      - name: Install dependencies & prepare for bundling
        # if: "!contains(github.event.commits[0].message, 'skip')"
        run: pnpm install
      # - name: Test components
        # run: yarn workspace @prism/components test --ci

      - name: Bundle Packages
        # if: "!contains(github.event.commits[0].message, 'skip')"
        run: pnpm turbo run build

      - name: Publish to Artifactory
        env:
          ARTIFACTORY_USERNAME: ${{ secrets.ARTIFACTORY_EMAIL }}
          ARTIFACTORY_API_KEY: ${{ secrets.ARTIFACTORY_TOKEN }}
          ARTIFACTORY_AUTH_URL: https://artifactory.coxautoinc.com/artifactory/api/npm/auth
        run: |
          for dir in tailwind-theme-prism heroicons heroicons/react tailwind-preset react-components tailwind-plugin-elements
          do
            pushd packages/$dir
            echo 'registry=https://artifactory.coxautoinc.com/artifactory/api/npm/man-npm' >> .npmrc
            curl -u${ARTIFACTORY_USERNAME}:${ARTIFACTORY_API_KEY} ${ARTIFACTORY_AUTH_URL} >> .npmrc
            echo 'publish-branch=release/2.0.9-alpha.3' >> .npmrc
            pnpm config set userconfig .npmrc
            pnpm publish --tag alpha --no-git-checks
            popd
          done || exit 1
